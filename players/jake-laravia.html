<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jake LaRavia • PrizePicks Edge</title>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../style.css" />
</head>
<body class="player-page">
  <a href="../index.html" class="back">Home</a>

  <header>
    <h1>PRIZEPICKS EDGE</h1>
    <div class="tag">WEAPONIZED STATS.</div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="player-img-container">
        <img id="playerHeadshot" src="https://www.basketball-reference.com/req/202106291/images/players/laravja01.jpg" alt="Jake LaRavia">
      </div>

      <div class="name">Jake LaRavia</div>
      <div class="meta-line">
        <div class="position" id="positionChip"></div>
        <div class="team">LAL</div>
        <div class="opponent">vs PHX</div>
      </div>

      <div class="prop-line">
        <select id="propSelect">
          <option value="Pts+Rebs">Pts+Rebs</option>
        </select>
        • Line <strong id="lineVal">8.0</strong> 
        • Projection <strong id="projectionVal">10.8</strong>
        • DVP <strong id="dvpVal">N/A</strong>
        <span id="edgeBadge"></span>
      </div>

      <!-- Scroll-snap hitrates with dots -->
      <div class="hitrates-wrapper">
        <div class="hitrates">
          <div class="rate-box"><div class="label">Last 5</div><div class="val">2/5</div></div>
          <div class="rate-box"><div class="label">Last 10</div><div class="val">5/10</div></div>
          <div class="rate-box"><div class="label">Last 20</div><div class="val">12/19</div></div>
          <div class="rate-box"><div class="label">Season</div><div class="val">12/19</div></div>
        </div>
        <div class="dots">
          <span class="dot active"></span>
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </div>
      </div>

      <div id="chart"></div>
    </div>
  </div>

  <!-- Your original script + dot sync (unchanged) -->
  <script>
    let line = Number('8.0');
    let data = JSON.parse('[18.0, 7.0, 6.0, 9.0, 10.0, 20.0, 6.0, 5.0, 2.0, 15.0]');
    let dates = JSON.parse('["11/08", "11/10", "11/12", "11/14", "11/15", "11/18", "11/23", "11/25", "11/28", "11/30"]');
    let projection = Number('10.8');
    const playerName = 'Jake LaRavia';

    (function(){
      const img = document.getElementById('playerHeadshot');
      if(!img) return;
      const container = img.parentElement;
      const initials = ("Jake LaRavia"||'').split(/\s+/).map(p=>p[0]||'').slice(0,2).join('').toUpperCase();
      function showFallback(){
        const div = document.createElement('div');
        div.className = 'avatar-fallback';
        div.textContent = initials || 'PP';
        try { container.replaceChild(div, img); } catch(e) {}
      }
      img.addEventListener('error', showFallback, { once: true });
    })();

    async function fetchPlayerProps(name){
      try{
        const res = await fetch('../PLAYER_UI_CARDS_PERFECT.json');
        const all = await res.json();
        return all.filter(r => (r.Name || r.name || '').toLowerCase() === String(name).toLowerCase());
      }catch(e){
        console.warn('Failed to fetch player props', e);
        return [];
      }
    }

    async function fetchPositions(){
      try{
        const res = await fetch('../nba_players_2025_26_positions.json');
        if(!res.ok) return {};
        return await res.json();
      }catch(e){
        console.warn('Failed to fetch positions', e);
        return {};
      }
    }

    async function fetchDVP(){
      try{
        const res = await fetch('../nba_dvp_latest.json');
        if(!res.ok) return [];
        const payload = await res.json();
        const rankings = (payload && payload.data && payload.data.team_dvp_rankings) || [];
        return rankings;
      }catch(e){
        console.warn('Failed to fetch DVP', e);
        return [];
      }
    }

    function mapStatToDVP(stat){
      const m = {
        'Points':'PTS','Rebounds':'REB','Assists':'AST','Threes':'3PM','Steals':'STL','Blocks':'BLK','Turnovers':'TOV',
        'Pts+Rebs':'PTS+REB','Pts+Asts':'PTS+AST','Rebs+Asts':'REB+AST','Pts+Rebs+Asts':'PTS+REB+AST','Fantasy Score':'FPTS'
      };
      return m[stat] || stat;
    }

    function computeDVP(rankings, team, position, stat){
      if(!Array.isArray(rankings)) return null;
      const statKey = mapStatToDVP(stat).toUpperCase();
      const posKey = String(position||'').toUpperCase();
      const teamKey = String(team||'').toUpperCase();
      const rows = rankings.filter(r => String(r.team||r.Team||'').toUpperCase()===teamKey && String(r.position||r.pos||'').toUpperCase()===posKey);
      if(!rows.length) return null;
      // If per-stat DVP present, pick matching; else fallback to generic dvp
      const statRow = rows.find(r => String(r.stat||r.Stat||'').toUpperCase()===statKey);
      const value = statRow ? (statRow.dvp ?? statRow.DVP ?? statRow.value) : (rows[0].dvp ?? rows[0].DVP ?? rows[0].value);
      return typeof value === 'number' ? value : Number(value||0);
    }

    function renderBadge(){
      const badgeEl = document.getElementById('edgeBadge');
      if(!badgeEl || !Array.isArray(data) || !data.length) return;
      const avg = data.reduce((a,b)=>a+b,0)/data.length;
      if(avg > line + 0.5) badgeEl.innerHTML = '<span class="badge-hot">STRONG EDGE</span>';
      else if(avg > line) badgeEl.innerHTML = '<span class="badge-hot">EDGE</span>';
      else if(avg < line - 0.5) badgeEl.innerHTML = '<span class="badge-cold">UNDER</span>';
      else badgeEl.innerHTML = '';
    }

    function renderChart(){
      try {
        Highcharts.chart('chart', {
          chart:{backgroundColor:'var(--pp-surface-alt)'},
          title:{text:'Last 10 Games',style:{color:'var(--pp-text-dim)',fontSize:'14px',fontWeight:'600'}},
          xAxis:{categories: (Array.isArray(dates) && dates.length === data.length) ? dates : data.map((_,i)=>'G'+(10-i)), labels:{style:{color:'var(--pp-text-dim)'}}},
          yAxis:{title:{text:document.getElementById('propSelect').value,style:{color:'var(--pp-text-dim)'}},gridLineColor:'rgba(255,255,255,0.05)',plotLines:[{value:line,color:'var(--pp-accent)',width:3,dashStyle:'Dash',label:{text:'Line '+line,style:{color:'var(--pp-accent)',fontWeight:'700'}}}]},
          legend:{enabled:false},
          tooltip:{backgroundColor:'var(--pp-surface)',borderColor:'var(--pp-border)',style:{color:'var(--pp-text)'}},
          series:[{type:'column',name:'Jake LaRavia',data:data.map(v=>({y:v,color:v>line?'var(--pp-success)':'var(--pp-danger)'})),borderRadius:4}]
        });
      } catch(e){
        document.getElementById('chart').innerHTML = '<div style="text-align:center;padding:40px;color:#ff6b6b;">Chart failed to load</div>';
      }
    }

    function renderHitrates(record){
      const boxes = document.querySelectorAll('.hitrates .rate-box .val');
      if(boxes.length < 4) return;
      const vals = [
        record.last_5 || '2/5',
        record.last_10 || '5/10',
        record.last_20 || '12/19',
        record.season || '12/19'
      ];
      vals.forEach((v, i) => {
        const { text, pct } = formatPercentFirstWithPct(v);
        boxes[i].textContent = text;
        boxes[i].classList.remove('hit-green','hit-neutral','hit-red');
        if (pct >= 75) boxes[i].classList.add('hit-green');
        else if (pct >= 60) boxes[i].classList.add('hit-neutral');
        else if (pct < 50) boxes[i].classList.add('hit-red');
        else boxes[i].classList.add('hit-neutral');
      });
    }

    function formatPercentFirstWithPct(ratioStr){
      const m = String(ratioStr).match(/^(\d+)\/(\d+)$/);
      if(!m) return { text: ratioStr, pct: NaN };
      const hits = Number(m[1]);
      const total = Number(m[2]) || 1;
      const pct = Math.round((hits/total)*100);
      return { text: `${pct}% • ${ratioStr}` , pct };
    }

    function updateUI(record){
      line = Number(record.Line ?? record.line);
      const series = record.last_10_values ?? record.last10_values ?? record.last_10;
      data = Array.isArray(series) ? series : data;
      projection = record.projection ?? record.Proj ?? record.projected ?? projection;
      document.getElementById('lineVal').textContent = line;
      document.getElementById('projectionVal').textContent = typeof projection === 'number' ? projection.toFixed(1) : (projection ?? 'N/A');
      renderBadge();
      renderHitrates(record);
      renderChart();
    }

    const hitratesEl = document.querySelector('.hitrates');
    const dots = document.querySelectorAll('.dot');
    function updateDots() {
      if (!hitratesEl) return;
      const index = Math.round(hitratesEl.scrollLeft / (hitratesEl.clientWidth + 12));
      dots.forEach((d, i) => d.classList.toggle('active', i === index));
    }
    if (hitratesEl) {
      hitratesEl.addEventListener('scroll', updateDots);
      window.addEventListener('resize', updateDots);
      updateDots();
    }

    (async function(){
      renderBadge();
      renderChart();
      // Append % to initial hitrates shown from template
      renderHitrates({});

      // Load positions and set chip
      const positionsMap = await fetchPositions();
      const posEl = document.getElementById('positionChip');
      let playerPosition = '';
      if (posEl && positionsMap) {
        const direct = positionsMap[playerName];
        if (direct) { posEl.textContent = direct; playerPosition = direct; }
        else {
          const key = Object.keys(positionsMap).find(k => k.toLowerCase() === playerName.toLowerCase());
          if (key) { posEl.textContent = positionsMap[key]; playerPosition = positionsMap[key]; }
          else posEl.style.display = 'none';
        }
      }

      // Load DVP rankings
      const dvpRankings = await fetchDVP();
      function updateDVPDisplay(currentStat){
        const oppTeam = 'PHX'.toUpperCase();
        const dvpVal = computeDVP(dvpRankings, oppTeam, playerPosition, currentStat);
        const dvpEl = document.getElementById('dvpVal');
        if(dvpEl){ dvpEl.textContent = (dvpVal!=null? dvpVal.toFixed(2): 'N/A'); }
      }

      const records = await fetchPlayerProps(playerName);
      const select = document.getElementById('propSelect');
      const current = select.value;
      const uniqueProps = Array.from(new Set(records.map(r => r.Stat || r.stat || r.prop))).filter(Boolean);
      const displayMap = { 'PRA': 'Pts+Rebs+Asts' };
      select.innerHTML = '';
      uniqueProps.forEach(p => {
        const disp = displayMap[p] || p;
        const opt = document.createElement('option');
        opt.value = disp; opt.textContent = disp;
        if(disp === current) opt.selected = true;
        select.appendChild(opt);
      });

      select.addEventListener('change', () => {
        const selected = select.value;
        const statKey = selected === 'Pts+Rebs+Asts' ? 'PRA' : selected;
        const rec = records.find(r => (r.Stat || r.stat || r.prop) === statKey);
        if(rec) updateUI(rec);
        updateDVPDisplay(selected);
      });

      // Initial DVP
      updateDVPDisplay(current);
    })();
  </script>
</body>
</html>